var CollisionManager=function(e){var t=e;var n=new Surface(surface?surface.canvas.width:100,surface?surface.canvas.height:100,DEBUG);var r=new Surface(surface?surface.canvas.width:100,surface?surface.canvas.height:100,DEBUG);var i=new Render(n.context);var s=new Render(r.context);var o=new Scene("collisionSource");var u=new Scene("collisionTarget");o.addChild(e);this.boxCollides=function(e,n){if(!e.visible)return false;if(t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y){if(!n){return true}else{return this.pixelPerfectCollides(e)}}return false};this.pointCollides=function(e){if(t.x<e.x&&t.x+t.width>e.x&&t.y<e.y&&t.y+t.height>e.y){return true}return false};this.pixelPerfectCollides=function(e){u.addChild(e);i.drawScene(o);s.drawScene(u);var f=a(t,e);if(!f)return;var l=n.context.getImageData(f.x,f.y,f.width,f.height);var c=r.context.getImageData(f.x,f.y,f.width,f.height);for(var h=0;h<l.data.length;h+=4){var p=l.data[h+3];var d=c.data[h+3];if(p!=0&&d!=0){return true}}return false};var a=function(e,t){var n;var r;var i={};var s={};i.centerX=e.x+(i.halfWidth=e.width/2);i.centerY=e.y+(i.halfHeight=e.height/2);s.centerX=t.x+(s.halfWidth=t.width/2);s.centerY=t.y+(s.halfHeight=t.height/2);n=Math.abs(i.centerX-s.centerX)-(i.halfWidth+s.halfWidth);r=Math.abs(i.centerY-s.centerY)-(i.halfHeight+s.halfHeight);if(n<0&&r<0){n=Math.min(Math.min(e.width,t.width),-n);r=Math.min(Math.min(e.height,t.height),-r);return{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y),width:n,height:r}}else{return null}}};var GAME_FPS=30;var DEBUG=false;var surface;var core;var Core=function(e,t,n){EventDispatcher.call(this);core=this;GAME_FPS=n;var r=[];this.preloadAssetsQueue=[];this.assets={};this.rootScene;this.currentScene;this.gameWidth=e;this.gameHeight=t;this.render;this.keyboard;var i=function(e){};this.init=function(){this.rootScene=new Scene("root");this.currentScene=this.rootScene;this.addScene(this.rootScene);surface=new Surface(this.gameWidth,this.gameHeight);this.render=new Render(surface.context);this.keyboard=new Keyboard;this.interval=setTimeout(this.tick.bind(this),1e3/GAME_FPS);window.addEventListener("keydown",this.keyboardHandler.bind(this),false);window.addEventListener("keyup",this.keyboardHandler.bind(this),false);surface.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),true)};this.preloadAsset=function(e){var t=new Image;t.src=e;t.id=e;this.preloadAssetsQueue.push(t);t.addEventListener("load",this.imageLoadHandler.bind(this))};this.imageLoadHandler=function(e){this.assets[e.srcElement.id]=e.srcElement;this.removeFromPreloadQueue(e.srcElement);if(this.preloadAssetsQueue.length==0){this.dispatchEvent(new Event("load"))}};this.removeFromPreloadQueue=function(e){for(var t=0;t<this.preloadAssetsQueue.length;t++){if(e===this.preloadAssetsQueue[t]){this.preloadAssetsQueue.splice(t,1);break}}};this.loadAsset=function(e){};this.addScene=function(e){r.push(e)};this.getScene=function(e){for(var t=0;t<r.length;t++){if(r[t].name===e)return r[t]}return null};this.changeScene=function(e){this.currentScene=this.getScene(e);if(this.currentScene===null){throw new CoreException("Scene not found")}};this.removeScene=function(e){delete this.scenes[e]};this.tick=function(){this.render.drawScene(this.currentScene);this.interval=setTimeout(this.tick.bind(this),1e3/GAME_FPS);var e=new Event("enterframe");this.dispatchEvent(e);this.currentScene.dispatchEvent(e)};this.keyboardHandler=function(e){this.dispatchEvent(e)};this.mouseDownHandler=function(e){var t=this.currentScene.getChildsUnderPoint({x:e.layerX,y:e.layerY});for(var n=0;n<t.length;n++){t[n].dispatchEvent(e)}this.dispatchEvent(e)}};var CoreException=function(e){this.message=e;this.name="CoreException"};var DisplayObject=function(e,t){EventDispatcher.call(this);this._originalWidth=e;this._originalHeight=t;this._collisionManager=new CollisionManager(this);this.x=0;this.y=0;this.rotation=0;this.rotationPoint={x:0,y:0};this.opacity=1;this.visible=true;this.width=e;this.height=t;this.boxCollides=function(e,t){return this._collisionManager.boxCollides(e,t)};this.pointCollides=function(e){return this._collisionManager.pointCollides(e)};this.pixelPerfectCollides=function(e){return this._collisionManager.pixelPerfectCollides(e)};this.getScaleX=function(){return this.width/this._originalWidth};this.getScaleY=function(){return this.height/this._originalHeight};this.setScaleX=function(e){this.width=this._originalWidth*e};this.setScaleY=function(e){this.height=this._originalHeight*e}};var EventDispatcher=function(){this._listeners={};this.addEventListener=function(e,t){if(typeof this._listeners[e]=="undefined"){this._listeners[e]=[]}this._listeners[e].push(t)};this.dispatchEvent=function(e){if(typeof e=="string"){e={type:e}}if(!e.target){e.target=this}if(!e.type){throw new Error("Event object missing 'type' property.")}if(this._listeners[e.type]instanceof Array){var t=this._listeners[e.type];for(var n=0,r=t.length;n<r;n++){t[n].call(this,e)}}};this.removeEventListener=function(e,t){if(this._listeners[e]instanceof Array){var n=this._listeners[e];for(var r=0,i=n.length;r<i;r++){if(n[r]===t){n.splice(r,1);break}}}}};var Keyboard=function(){var e=function(e){Keyboard.pressedKeys[e.keyCode]=true};var t=function(e){Keyboard.pressedKeys[e.keyCode]=false};window.addEventListener("keydown",e.bind(this),false);window.addEventListener("keyup",t.bind(this),false)};Keyboard.KEY_CODES={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,"Pause/Break":19,"Caps Lock":20,Esc:27,Space:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Windows:91,"Right Click":93,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,"Numpad *":106,"Numpad +":107,"Numpad -":109,"Numpad .":110,"Numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"Num Lock":144,"Scroll Lock":145,"My Computer":182,"My Calculator":183,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222};Keyboard.pressedKeys={};var Render=function(e){this.context=e;this.canRender=true;this.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)};this.drawScene=function(e){if(this.canRender){this.clear();if(!e)return;for(var t=0;t<e.childs.length;t++){var n=e.childs[t];if(n.visible){this.context.save();this.context.globalAlpha=n.opacity;if(n instanceof TextField){n.rotationPoint.x=0;n.rotationPoint.y=0}var r=n.x+n.rotationPoint.x;var i=n.y+n.rotationPoint.y;this.context.translate(r,i);var s=n.rotation*Math.PI/180;this.context.rotate(s);this.context.translate(-r,-i);if(n instanceof TextField){this.context.font=n.getFont();this.context.textAlign=n.textAlign;this.context.fillStyle=n.fontColor;var o=this.context.measureText(n.text);n.width=o.width;n.height=o.height;this.context.fillText(n.text,n.x,n.y)}else if(n instanceof SpriteSheet){this.context.drawImage(n.image,n.getCol()*n.width,n.getRow()*n.height,n.width,n.height,n.x,n.y,n.width,n.height);n.update()}else{this.context.drawImage(n.image,n.x,n.y,n.width,n.height)}this.context.globalAlpha=1;this.context.restore()}}}}};var Scene=function(e){EventDispatcher.call(this);this.childs=[];this.backgroundMap=null;this.foregroundMap=null;this.name=e;this.context=null;this.addChild=function(e){if(this.getChildIndex(e)==-1){this.childs.push(e)}};this.setChildIndex=function(e,t){if(t>=this.childs.length)throw new Error("Index out of bounds");var n=this.childs.indexOf(e);if(n==-1)throw new SceneException("Child not found");this.childs.splice(n,1);this.childs.splice(t,0,e)};this.getChildIndex=function(e){return this.childs.indexOf(e)};this.getChildsUnderPoint=function(e){var t=[];for(var n=0;n<this.childs.length;n++){var r=this.childs[n];if(!r.visible)continue;if(r.pointCollides(e)){t.push(r)}}return t};this.removeChildAt=function(e){if(e>=this.childs.length)throw new Error("Index out of bounds");this.childs.splice(e,1)}};var SceneException=function(e){this.message=e;this.name="SceneException"};var Sprite=function(e,t,n){DisplayObject.call(this,e,t);this.tweenGroup=new TweenGroup(this);this.image=n};var SpriteSheet=function(e,t,n,r){Sprite.call(this,e,t,n);var i=0;var s=0;var o=0;var u=Math.floor(n.width/this.width);var r=r;var a=true;this.animations={};this.currentAnimation="";this.update=function(){if(a)return;o++;if(o<r)return;if(o==r)o=0;if(this.currentAnimation.length){var e=this.animations[this.currentAnimation];s++;if(s>=e.frames.length){if(e.hasOwnProperty("next")){this.setCurrentAnimation(e["next"])}else{s=0}}i=e.frames[s]}else{i++;if(i>=this.image.width/this.width*(this.image.height/this.height)){i=0}}};this.setCurrentAnimation=function(e){this.currentAnimation=e;i=this.animations[e].frames[0];s=0;if(this.animations[e].hasOwnProperty("speed")){r=this.animations[e]["speed"]}a=false};this.stop=function(e){if(e==null){if(this.currentAnimation.length){i=this.animations[this.currentAnimation].frames[0]}else{i=0}}else{i=e}a=true};this.getCol=function(){return Math.floor(i%u)};this.getRow=function(){return Math.floor(i/u)}};var Surface=function(e,t,n){if(n==null){n=true}this.canvas=document.createElement("canvas");this.canvas.width=e;this.canvas.height=t;this.canvas.style.border="1px solid";if(n)document.body.appendChild(this.canvas);this.context=this.canvas.getContext("2d")};var TextField=function(e,t,n,r,i){DisplayObject.call(this);this.text=e;this.fontType=t;this.fontSize=n;this.fontColor=r;this.textAlign=i;this.getFont=function(){return this.fontSize+"pt "+this.fontType}};var Tween=function(e){EventDispatcher.call(this);this.target=e;this.properties={};this.interval;this.steps;this.running=false;this.moveTo=function(e,t,n,r){if(r==null){r=Ease.linear}this.properties["x"]={startPos:this.target.x,endPos:e,ease:r};this.properties["y"]={startPos:this.target.y,endPos:t,ease:r};this.steps=n};this.scaleTo=function(e,t,n,r){if(r==null){r=Ease.linear}this.properties["width"]={startPos:this.target.width,endPos:this.target.width*e,ease:r};this.properties["height"]={startPos:this.target.height,endPos:this.target.height*t,ease:r};this.steps=n};this.to=function(e,t){this.steps=e;var n=null;if(t["ease"]){n=t["ease"]}else{n=Ease.linear}for(var r in t){if(r=="scaleX"){this.properties["width"]={startPos:this.target["width"],endPos:this.target["width"]*t[r],ease:n}}else if(r=="scaleY"){this.properties["height"]={startPos:this.target["height"],endPos:this.target["height"]*t[r],ease:n}}else if(r!="ease"){this.properties[r]={startPos:this.target[r],endPos:t[r],ease:n}}}};this.start=function(){for(var e in this.properties){this.properties[e].values=this.calculateValues(this.properties[e]);this.properties[e].index=0;this.properties[e].finished=false}this.playInterval();this.running=true};this.playInterval=function(){this.interval=setTimeout(this.loop.bind(this),1e3/GAME_FPS)};this.loop=function(){for(var e in this.properties){if(!this.properties[e].finished){if(this.properties[e].index==this.steps){this.properties[e].finished=true}else{this.target[e]=this.properties[e].values[this.properties[e].index];this.properties[e].index+=1}}}var t=true;for(var e in this.properties){if(!this.properties[e].finished){t=false;break}}if(!t){this.playInterval()}else{this.running=false;this.dispatchEvent("complete")}};this.calculateValues=function(e){var t=[];for(var n=0;n<this.steps;n++){var r=e.startPos;var i=n+1;var s=this.steps;var o=e.endPos-e.startPos;t.push(e.ease(i,r,o,s))}return t}};var Ease={linear:function(e,t,n,r){return n*(e/r)+t},easeInQuad:function(e,t,n,r){return n*(e/=r)*e+t},easeOutQuad:function(e,t,n,r){return-n*(e/=r)*(e-2)+t},easeInOutQuad:function(e,t,n,r){if((e/=r/2)<1)return n/2*e*e+t;return-n/2*(--e*(e-2)-1)+t},easeInElastic:function(e,t,n,r){var i=1.70158;var s=0;var o=n;if(e==0)return t;if((e/=r)==1)return t+n;if(!s)s=r*.3;if(o<Math.abs(n)){o=n;var i=s/4}else{var i=s/(2*Math.PI)*Math.asin(n/o)}return-(o*Math.pow(2,10*(e-=1))*Math.sin((e*r-i)*2*Math.PI/s))+t},easeOutElastic:function(e,t,n,r){var i=1.70158;var s=0;var o=n;if(e==0)return t;if((e/=r)==1)return t+n;if(!s)s=r*.3;if(o<Math.abs(n)){o=n;var i=s/4}else{var i=s/(2*Math.PI)*Math.asin(n/o)}return o*Math.pow(2,-10*e)*Math.sin((e*r-i)*2*Math.PI/s)+n+t},easeInOutElastic:function(e,t,n,r){var i=1.70158;var s=0;var o=n;if(e==0)return t;if((e/=r/2)==2)return t+n;if(!s)s=r*.3*1.5;if(o<Math.abs(n)){o=n;var i=s/4}else{var i=s/(2*Math.PI)*Math.asin(n/o)}if(e<1)return-.5*o*Math.pow(2,10*(e-=1))*Math.sin((e*r-i)*2*Math.PI/s)+t;return o*Math.pow(2,-10*(e-=1))*Math.sin((e*r-i)*2*Math.PI/s)*.5+n+t}};var TweenGroup=function(e){EventDispatcher.call(this);this.tweens=[];this.target=e;this.loop=false;this.moveTo=function(e,t,n,r){var i=new Tween(this.target);i.moveTo(e,t,n,r);this.addTween(i);return this};this.scaleTo=function(e,t,n,r){var i=new Tween(this.target);i.scaleTo(e,t,n,r);this.addTween(i);return this};this.to=function(e,t){var n=new Tween(this.target);n.to(e,t);this.addTween(n);return this};this.addTween=function(e){e.addEventListener("complete",this.completeTweenHandler.bind(this));if(this.tweens.length==0)e.start();this.tweens.push(e)};this.completeTweenHandler=function(e){var t=this.tweens.indexOf(e.target);var n=this.tweens.splice(t,1)[0];if(this.loop){this.tweens.push(n)}if(this.tweens.length==0){this.dispatchEvent("complete")}else{this.updateNextTweenPropertiesAndStartThen();this.dispatchEvent("tween_completed")}};this.updateNextTweenPropertiesAndStartThen=function(){var e=this.tweens[0];for(var t in e.properties){e.properties[t].startPos=this.target[t]}e.start()};this.setLoop=function(e){this.loop=e}}